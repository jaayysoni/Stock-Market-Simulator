<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Dashboard – Stock Market Simulator</title>
<link rel="stylesheet" href="/static/css/dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- ======= HEADER ======= -->
<header class="header">
    <div class="logo">Stock Market Simulator</div>
    <nav class="main-nav">
        <ul>
            <li><a href="#portfolio">Portfolio</a></li>
            <li><a href="#orders">Orders</a></li>
            <li><a href="/static/watchlist.html">Watchlist</a></li>
            <li><a href="/static/tradingterminal.html">Trading-Terminal</a></li>
            <li><a href="/static/login.html">Logout</a></li>
        </ul>
    </nav>
</header>

<!-- ======= MAIN CONTAINER ======= -->
<!-- <div class="dashboard-container">
    <aside class="sidebar">
        <ul>
            <li class="active"> Dashboard</li>
            <li>Markets</li>
            <li><a href="/static/watchlist.html"> watchlist</a></li>
            <li> Orders</li>
            <li><a href="/static/tradingterminal.html"> Trading-Terminal</a></li>
        </ul>
    </aside> -->

    <!-- ======= CONTENT AREA ======= -->
    <main class="content">
        <!-- ======= MARKET CHART ======= -->
        <!DOCTYPE html>
        <html>
        <head>
        <style>
        /* ===== General Card Styling ===== */
        .card {
            background-color: #0e1117;
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* ===== Market Overview Flex Container ===== */
        .market-overview {
            display: flex;
            gap: 20px; /* space between cards */
            flex-wrap: wrap; /* wrap on small screens */
            margin-bottom: 20px;
        }
        
        /* ===== Individual Market Containers ===== */
        .market-container {
            flex: 1 1 200px; /* flexible width, min 200px */
        }
        
        /* ===== Index Card Styling ===== */
        .index-card {
            background-color: #0e1117;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .index-card h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .index-card .price {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .index-card .change {
            font-size: 1rem;
            color: #0f0; /* green for positive, can change dynamically */
        }
        
        /* ===== Chart Styling ===== */
        #chartCanvas {
            width: 100%;
            height: 300px;
            background-color: #2a2a3e;
            border-radius: 10px;
        }
        </style>
        </head>
        <body>
        
        <section id="market-chart" class="card">
            <h2>Market Overview</h2>
            
            <!-- Market Overview Wrapper -->
            <div class="market-overview">
                <!-- BSE Container -->
                <div class="market-container" id="bse-container">
                  <div class="index-card">
                    <h3>BSE</h3>
                    <p class="price" id="bse-price">--</p>
                    <p class="change" id="bse-change">--</p>
                  </div>
                </div>
              
                <!-- NSE Container -->
                <div class="market-container" id="nse-container">
                  <div class="index-card">
                    <h3>NSE</h3>
                    <p class="price" id="nse-price">--</p>
                    <p class="change" id="nse-change">--</p>
                  </div>
                </div>
              
                <!-- Bank Nifty Container -->
                <div class="market-container" id="banknifty-container">
                  <div class="index-card">
                    <h3>Bank Nifty</h3>
                    <p class="price" id="banknifty-price">--</p>
                    <p class="change" id="banknifty-change">--</p>
                  </div>
                </div>
            </div>
            <!-- Chart Canvas -->
            <canvas id="chartCanvas"></canvas>
        </section>

        <!-- ======= WATCHLIST ======= -->
        <!-- <section id="watchlist" class="card">
            <h2>Watchlist</h2>
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price (INR)</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody id="watchlist-body"></tbody>
            </table>
        </section> -->

        <!-- ======= TOP WINNERS ======= -->
<section id="top-winners" class="card">
    <h2>Top Winners of the Day</h2>
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Current Price (INR)</th>
                <th>Gain %</th>
                <th>Current Value (₹)</th>
            </tr>
        </thead>
        <tbody id="top-winners-body">
            <!-- Top 4 winners will be dynamically injected here -->
        </tbody>
    </table>
</section>

<!-- ======= TOP LOSERS ======= -->
<section id="top-losers" class="card">
    <h2>Top Losers of the Day</h2>
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Current Price (INR)</th>
                <th>Loss %</th>
                <th>Current Value (₹)</th>
            </tr>
        </thead>
        <tbody id="top-losers-body">
            <!-- Top 4 losers will be dynamically injected here -->
        </tbody>
    </table>
</section>

<section id="portfolio" class="card">
    <h2>Portfolio Summary</h2>
    <table>
        <thead>
            <tr>
                <th>Stock</th>
                <th>Quantity</th>
                <th>Avg. Buy Price (₹)</th>
                <th>Total (₹)</th>
                <th>Current Price (₹)</th>
            </tr>
        </thead>
        <tbody id="portfolio-summary-body">
            <!-- Portfolio stocks will be dynamically injected here -->
        </tbody>
    </table>
</section>


 <!-- ======= ORDERS ======= -->
 <section id="orders" class="card">
    <h2>Recent Orders</h2>
    <table>
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="orders-body"></tbody>
    </table>
</section>
    </main>
</div>


<script>
    // ===== Dashboard Authentication & Data =====
    let allSymbols = []; // Global symbols array
    let topChart;
    
    document.addEventListener("DOMContentLoaded", async () => {
        // ===== Fetch user info using HTTP-only cookie =====
        let user;
        try {
            const res = await fetch("/auth/me", {
                method: "GET",
                credentials: "include" // Important: sends cookie with request
            });
            if (!res.ok) throw new Error("Unauthorized");
            user = await res.json();
        } catch (err) {
            console.error(err);
            // If token invalid or not logged in, redirect to login
            window.location.href = "/static/login.html";
            return;
        }
    
        // ===== Update UI =====
        document.querySelector(".logo").textContent = `Welcome, ${user.username}`;
        const portfolioEl = document.getElementById("portfolio-summary-body");
        if (portfolioEl) {
            portfolioEl.innerHTML = `
                <tr>
                    <td colspan="2">Email: ${user.email}</td>
                    <td colspan="2">Virtual Balance: ₹${user.virtual_balance}</td>
                </tr>
            `;
        }
    
        // ===== Fetch all stock symbols =====
        try {
            const res = await fetch("/stocks/all");
            const data = await res.json();
            allSymbols = data.symbols || [];
        } catch (err) {
            console.error("Error fetching symbols:", err);
        }
    
        // ===== Fetch prices =====
        async function fetchPricesChunk(symbolsChunk) {
            try {
                const res = await fetch(`/stocks/prices?symbols=${symbolsChunk.join(",")}`);
                const data = await res.json();
                return data.prices || {};
            } catch (err) {
                console.error("Error fetching prices:", err);
                return {};
            }
        }
    
        async function fetchAllPrices(symbols, chunkSize = 50) {
            const prices = {};
            for (let i = 0; i < symbols.length; i += chunkSize) {
                const chunk = symbols.slice(i, i + chunkSize);
                const chunkPrices = await fetchPricesChunk(chunk);
                Object.assign(prices, chunkPrices);
            }
            return prices;
        }
    
        // ===== Render Watchlist (if used) =====
        const watchlistBody = document.getElementById("watchlist-body");
        async function renderWatchlist() {
            const prices = await fetchAllPrices(allSymbols);
            if (watchlistBody) {
                watchlistBody.innerHTML = "";
                allSymbols.forEach(symbol => {
                    const price = prices[symbol] != null ? prices[symbol].toFixed(2) : "N/A";
                    const row = document.createElement("tr");
                    row.innerHTML = `<td>${symbol}</td><td>${price}</td><td>-</td>`;
                    watchlistBody.appendChild(row);
                });
            }
    
            // Update chart (top 10)
            if (topChart) {
                topChart.data.datasets[0].data = allSymbols.slice(0,10).map(s => prices[s] || 0);
                topChart.update();
            }
        }
    
        // ===== Initialize Chart =====
        const top10Symbols = allSymbols.slice(0, 10);
        const ctx = document.getElementById("chartCanvas").getContext("2d");
        topChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: top10Symbols,
                datasets: [{
                    label: 'Price (INR)',
                    data: Array(top10Symbols.length).fill(0),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: false } } }
        });
    
        // Render watchlist initially and update every second
        setInterval(renderWatchlist, 1000);
    
        // ===== Logout Button =====
        document.querySelectorAll('a[href="/static/login.html"]').forEach(link => {
            link.addEventListener("click", async (e) => {
                e.preventDefault();
                // Call backend logout to clear HTTP-only cookie
                await fetch("/auth/logout", { method: "POST", credentials: "include" });
                window.location.href = "/static/login.html";
            });
        });
    
        // ===== Render Top Winners =====
        renderTopWinners();
    });
    
    // ===== Render Top Winners =====
    async function renderTopWinners() {
        if (!allSymbols.length) return;
        const prices = await fetchAllPrices(allSymbols);
        const winners = allSymbols.map(symbol => {
            const current = prices[symbol] || 0;
            const previous = current * (1 - Math.random() * 0.05);
            const gainPercent = previous > 0 ? ((current - previous)/previous)*100 : 0;
            return { symbol, current, gainPercent, currentValue: current*10 };
        }).sort((a,b) => b.gainPercent - a.gainPercent)
          .slice(0, 4);
    
        const tbody = document.getElementById("top-winners-body");
        if (tbody) {
            tbody.innerHTML = "";
            winners.forEach(stock => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${stock.symbol}</td>
                    <td>₹${stock.current.toFixed(2)}</td>
                    <td style="color: #4ade80;">${stock.gainPercent.toFixed(2)}%</td>
                    <td>₹${stock.currentValue.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }
    
    /* ===== Commented Out (Old localStorage JWT logic for manual login) =====
    
    // const urlParams = new URLSearchParams(window.location.search);
    // const tokenFromUrl = urlParams.get("token");
    // if (tokenFromUrl) {
    //     localStorage.setItem("access_token", tokenFromUrl);
    //     window.history.replaceState({}, document.title, window.location.pathname);
    // }
    // const token = localStorage.getItem("access_token");
    // if (!token) {
    //     alert("You must login first!");
    //     window.location.href = "/static/login.html";
    // }
    
    */
    </script>