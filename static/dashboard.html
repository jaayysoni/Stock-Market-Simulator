<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Dashboard â€“ Stock Market Simulator</title>
<link rel="stylesheet" href="/static/css/dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== General Card Styling ===== */
.card {
    background-color: #0e1117;
    border-radius: 12px;
    padding: 20px;
    margin: 20px;
    color: #fff;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

/* ===== Market Overview Flex Container ===== */
.market-overview {
    display: flex;
    gap: 20px; 
    flex-wrap: wrap; 
    margin-bottom: 20px;
}

/* ===== Individual Market Containers ===== */
.market-container {
    flex: 1 1 200px; 
}

/* ===== Index Card Styling ===== */
.index-card {
    background-color: #0e1117;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.index-card h3 { margin-bottom: 10px; font-size: 1.2rem; }
.index-card .price { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
.index-card .change { font-size: 1rem; }

/* ===== DASHBOARD BALANCE SECTION ===== */
.dashboard-balance {
    background-color: #161b22;
    padding: 20px 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    max-width: 400px;
    margin: 20px auto;
    text-align: center;
    transition: all 0.3s ease;
}
.dashboard-balance h2 {
    margin: 0 0 10px;
    font-size: 1.3rem;
    color: #e5e7eb;
}
.dashboard-balance p#balance {
    font-size: 1.6rem;
    font-weight: 600;
    margin: 10px 0 15px;
    color: #22c55e;
}
.funds-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}
.funds-controls input[type="number"] {
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    outline: none;
    width: 130px;
    font-size: 1rem;
    background-color: #0f172a;
    color: #e5e7eb;
}
.funds-controls input[type="number"]::placeholder { color: #94a3b8 }
.funds-controls .btn { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; color: #fff; }
.funds-controls .btn.add { background-color: #22c55e; }
.funds-controls .btn.add:hover { background-color: #16a34a; }
.funds-controls .btn.remove { background-color: #ef4444; }
.funds-controls .btn.remove:hover { background-color: #dc2626; }
@media (max-width: 480px) {
    .dashboard-balance { padding: 15px 20px; }
    .funds-controls { flex-direction: column; }
    .funds-controls input[type="number"], .funds-controls .btn { width: 100%; }
}
</style>
</head>
<body>

<header class="header">
    <div class="logo">Stock Market Simulator</div>
    <nav class="main-nav">
        <ul>
            <li><a href="/static/portfolio.html">Portfolio</a></li>
            <li><a href="/static/transaction.html">Transactions</a></li>
            <li><a href="/static/watchlist.html">Watchlist</a></li>
            <li><a href="/static/tradingterminal.html">Trading-Terminal</a></li>
            <li><a href="/static/login.html">Logout</a></li>
        </ul>
    </nav>
</header>

<main class="content">

<!-- ===== Market Overview ===== -->
<section id="market-chart" class="card">
    <h2>Market Overview</h2>
    <div class="market-overview">
        <div class="market-container">
            <div class="index-card" data-symbol="BSE">
                <h3>BSE</h3>
                <p class="price" id="bse-price">--</p>
                <p class="change" id="bse-change">--</p>
            </div>
        </div>
        <div class="market-container">
            <div class="index-card" data-symbol="NSE">
                <h3>NSE</h3>
                <p class="price" id="nse-price">--</p>
                <p class="change" id="nse-change">--</p>
            </div>
        </div>
        <div class="market-container">
            <div class="index-card" data-symbol="BANKNIFTY">
                <h3>Bank Nifty</h3>
                <p class="price" id="banknifty-price">--</p>
                <p class="change" id="banknifty-change">--</p>
            </div>
        </div>
        <div class="market-container">
            <div class="index-card" data-symbol="NIFTY50">
                <h3>Nifty 50</h3>
                <p class="price" id="nifty50-price">--</p>
                <p class="change" id="nifty50-change">--</p>
            </div>
        </div>
    </div>
</section>

<!-- ===== Top Winners ===== -->
<section id="top-winners" class="card">
    <h2>Top Winners of the Day</h2>
    <div class="market-overview" id="top-winners-body"></div>
</section>

<!-- ===== Top Losers ===== -->
<section id="top-losers" class="card">
    <h2>Top Losers of the Day</h2>
    <div class="market-overview" id="top-losers-body"></div>
</section>

<!-- ===== Dashboard Balance ===== -->
<section class="dashboard-balance">
    <h2>ðŸ’° Available Balance</h2>
    <p id="balance">â‚¹100000</p>
    <div class="funds-controls">
      <input type="number" id="balanceInput" placeholder="Enter Amount" />
      <button id="addFundsBtn" class="btn add">Add Funds</button>
      <button id="removeFundsBtn" class="btn remove">Remove Funds</button>
    </div>
</section>

</main>

<script>
let stockPrices = {};
let niftyPrice = 0;

// ===== Market Overview =====
async function fetchMarketOverview() {
    try {
        const res = await fetch("/stocks/indices");
        if (!res.ok) throw new Error("Failed to fetch indices");
        const data = await res.json();

        const setValue = (id, value, change) => {
            const formattedPrice = value != null ? value.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "--";
            const formattedChange = change != null ? change.toFixed(2) : "--";

            document.getElementById(`${id}-price`).innerText = formattedPrice;
            const changeEl = document.getElementById(`${id}-change`);
            changeEl.innerText = formattedChange !== "--" ? `${formattedChange}%` : "--";
            changeEl.style.color = change >= 0 ? "#4ade80" : "#f87171";
        };

        setValue("bse", data.BSE?.price, data.BSE?.change);
        setValue("nse", data.NSE?.price, data.NSE?.change);
        setValue("banknifty", data.BankNifty?.price, data.BankNifty?.change);

        niftyPrice = data.Nifty50?.price || 0;
        const niftyPriceEl = document.getElementById("nifty50-price");
        const niftyChangeEl = document.getElementById("nifty50-change");
        if(niftyPriceEl) niftyPriceEl.innerText = niftyPrice.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        if(niftyChangeEl) {
            const change = data.Nifty50?.change || 0;
            niftyChangeEl.innerText = change.toFixed(2) + "%";
            niftyChangeEl.style.color = change >= 0 ? "#4ade80" : "#f87171";
        }
    } catch (err) {
        console.error("Market overview error:", err);
    }
}

// ===== Top Movers =====
async function fetchTopMovers() {
    try {
        const res = await fetch("/market/top-movers");
        if (!res.ok) throw new Error("Failed to fetch top movers");
        const data = await res.json();

        const formatPrice = val => val != null ? val.toLocaleString('en-IN',{ minimumFractionDigits:2, maximumFractionDigits:2 }) : "--";
        const formatChange = val => val != null ? val.toFixed(2) : "--";

        const winnersContainer = document.getElementById("top-winners-body");
        winnersContainer.innerHTML = "";
        data.gainers.forEach(s => {
            const card = document.createElement("div");
            card.className = "index-card";
            card.innerHTML = `<h3>${s.symbol}</h3><p class="price">â‚¹${formatPrice(s.price)}</p><p class="change" style="color:#4ade80;">${formatChange(s.change)}%</p>`;
            winnersContainer.appendChild(card);
        });

        const losersContainer = document.getElementById("top-losers-body");
        losersContainer.innerHTML = "";
        data.losers.forEach(s => {
            const card = document.createElement("div");
            card.className = "index-card";
            card.innerHTML = `<h3>${s.symbol}</h3><p class="price">â‚¹${formatPrice(s.price)}</p><p class="change" style="color:#f87171;">${formatChange(s.change)}%</p>`;
            losersContainer.appendChild(card);
        });
    } catch(err) {
        console.error("Top movers fetch error:", err);
    }
}

// ===== Balance Controls =====
function updateBalance(amount) {
    const balanceEl = document.getElementById("balance");
    let current = parseFloat(balanceEl.innerText.replace(/â‚¹|,/g, ""));
    current += amount;
    balanceEl.innerText = "â‚¹" + current.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

document.getElementById("addFundsBtn").addEventListener("click", () => {
    const val = parseFloat(document.getElementById("balanceInput").value);
    if(!isNaN(val) && val > 0) updateBalance(val);
});

document.getElementById("removeFundsBtn").addEventListener("click", () => {
    const val = parseFloat(document.getElementById("balanceInput").value);
    if(!isNaN(val) && val > 0) updateBalance(-val);
});

// ===== WebSocket for live portfolio & top movers =====
function setupWebSocket() {
    const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProtocol}://${location.host}/ws/stocks`);

    ws.onopen = () => console.log("âœ… Connected to WebSocket");

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (!data?.symbol || data.price == null) return;
            stockPrices[data.symbol] = { price: data.price, change: data.change || 0 };
            fetchMarketOverview();
            fetchTopMovers();
        } catch(err) {
            console.error("WebSocket message error:", err);
        }
    };

    ws.onclose = () => setTimeout(setupWebSocket, 5 * 60 * 1000);
    ws.onerror = (err) => console.error("WebSocket error:", err);
}

// ===== Initialization =====
document.addEventListener("DOMContentLoaded", () => {
    fetchMarketOverview();
    fetchTopMovers();
    setupWebSocket();

    setInterval(fetchMarketOverview, 10 * 60 * 1000);
    setInterval(fetchTopMovers, 10 * 60 * 1000);
});
</script>
</body>
</html>