<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Dashboard – Stock Market Simulator</title>
<link rel="stylesheet" href="/static/css/dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- ======= HEADER ======= -->
<header class="header">
    <div class="logo">Stock Market Simulator</div>
    <nav class="main-nav">
        <ul>
            <li><a href="#">Overview</a></li>
            <li><a href="#">Watchlist</a></li>
            <li><a href="#">Orders</a></li>
            <li><a href="#">Portfolio</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
    </nav>
</header>

<!-- ======= MAIN CONTAINER ======= -->
<div class="dashboard-container">
    <!-- ======= SIDEBAR ======= -->
    <aside class="sidebar">
        <ul>
            <li class="active"> Dashboard</li>
            <li> Markets</li>
            <li> Portfolio</li>
            <li> Orders</li>
            <li> Settings</li>
        </ul>
    </aside>

    <!-- ======= CONTENT AREA ======= -->
    <main class="content">
        <!-- ======= MARKET CHART ======= -->
        <section id="market-chart" class="card">
            <h2>Market Overview</h2>
            <canvas id="chartCanvas"></canvas>
        </section>

        <!-- ======= WATCHLIST ======= -->
        <section id="watchlist" class="card">
            <h2>Watchlist</h2>
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price (INR)</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody id="watchlist-body"></tbody>
            </table>
        </section>

        <!-- ======= ORDERS ======= -->
        <section id="orders" class="card">
            <h2>Recent Orders</h2>
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="orders-body"></tbody>
            </table>
        </section>

        <!-- ======= PORTFOLIO ======= -->
        <section id="portfolio" class="card">
            <h2>Portfolio Summary</h2>
            <div id="portfolio-summary"></div>
        </section>
    </main>
</div>

<!-- ======= DASHBOARD SCRIPT ======= -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("access_token");
    if (!token) window.location.href = "/Login";

    // Fetch user info
    let user;
    try {
        const res = await fetch("/auth/me", { headers: { "Authorization": `Bearer ${token}` } });
        if (!res.ok) throw new Error("Unauthorized");
        user = await res.json();
    } catch (err) {
        console.error(err);
        window.location.href = "/Login";
    }

    document.querySelector(".logo").textContent = `Welcome, ${user.username}`;
    document.getElementById("portfolio-summary").innerHTML = `
        <p>Email: ${user.email}</p>
        <p>Virtual Balance: ₹${user.virtual_balance}</p>
    `;
    document.getElementById("orders-body").innerHTML = `
        <tr><td>1</td><td>Buy</td><td>10</td><td>Completed</td></tr>
        <tr><td>2</td><td>Sell</td><td>5</td><td>Pending</td></tr>
    `;

    // ======= FETCH ALL STOCK SYMBOLS =======
    let allSymbols = [];
    try {
        const res = await fetch("/stocks/all");
        const data = await res.json();
        allSymbols = data.symbols; // 500 symbols
    } catch (err) {
        console.error("Error fetching symbols:", err);
    }

    // ======= FETCH PRICES =======
    async function fetchPricesChunk(symbolsChunk) {
        try {
            const res = await fetch(`/stocks/prices?symbols=${symbolsChunk.join(",")}`);
            const data = await res.json();
            return data.prices;
        } catch (err) {
            console.error("Error fetching prices:", err);
            return {};
        }
    }

    async function fetchAllPrices(symbols, chunkSize = 50) {
        const prices = {};
        for (let i = 0; i < symbols.length; i += chunkSize) {
            const chunk = symbols.slice(i, i + chunkSize);
            const chunkPrices = await fetchPricesChunk(chunk);
            Object.assign(prices, chunkPrices);
        }
        return prices;
    }

    // ======= RENDER WATCHLIST =======
    const watchlistBody = document.getElementById("watchlist-body");
    async function renderWatchlist() {
        const prices = await fetchAllPrices(allSymbols);
        watchlistBody.innerHTML = "";
        allSymbols.forEach(symbol => {
            const price = prices[symbol] !== null ? prices[symbol].toFixed(2) : "N/A";
            const row = document.createElement("tr");
            row.innerHTML = `<td>${symbol}</td><td>${price}</td><td>-</td>`;
            watchlistBody.appendChild(row);
        });

        // Update chart (top 10)
        topChart.data.datasets[0].data = allSymbols.slice(0,10).map(s => prices[s] || 0);
        topChart.update();
    }

    // ======= RENDER CHART =======
    const top10Symbols = allSymbols.slice(0, 10);
    const top10Prices = {};
    top10Symbols.forEach(s => top10Prices[s] = 0);

    const ctx = document.getElementById("chartCanvas").getContext("2d");
    const topChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: top10Symbols,
            datasets: [{
                label: 'Price (INR)',
                data: Object.values(top10Prices),
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: false
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });

    // Update every second
    setInterval(renderWatchlist, 1000);

    // ======= LOGOUT BUTTON =======
    const logoutBtn = document.createElement("button");
    logoutBtn.textContent = "Logout";
    logoutBtn.className = "logout-btn";
    logoutBtn.style.position = "absolute";
    logoutBtn.style.right = "20px";
    logoutBtn.style.top = "20px";
    logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("access_token");
        window.location.href = "/Login";
    });
    document.body.appendChild(logoutBtn);
});
</script>
</body>
</html>