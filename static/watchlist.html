<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Watchlist — Stock Market Simulator</title>
<style>
/* ===== Theme & Layout ===== */
:root{
  --bg:#0f1418;
  --panel:#1f242c;
  --panel-hover:#252b34;
  --muted:#9aa1ab;
  --accent:#00c2ff;
  --danger:#ff5757;
  --text:#e6e6e6;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Header */
.header{
  display:flex;
  justify-content:space-between;
  gap:16px;
  align-items:center;
  padding:14px 20px;
  background:#161b22;
  border-bottom:1px solid #222;
  position:sticky;
  top:0;
  z-index:100;
}
.brand{font-weight:700;color:var(--accent);font-size:1.05rem}
.main-nav ul{display:flex;gap:14px;list-style:none;margin:0;padding:0}
.main-nav a{color:#dcdcdc;text-decoration:none;font-weight:500}
.main-nav a:hover{color:var(--accent)}

/* Main content */
.content{
  max-width:960px;
  margin:18px auto;
  padding:0 18px 48px;
}

/* Controls */
.controls{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
  margin-bottom:18px;
  flex-wrap:wrap;
}
#w-search{
  min-width:220px;
  padding:8px 10px;
  border-radius:8px;
  border:1px solid #2f353b;
  background:#0b0f11;
  color:var(--text);
}
.btn{
  padding:8px 12px;border-radius:8px;border:0;font-weight:700;cursor:pointer;
}
.btn-primary{background:var(--accent);color:#07202a}
.btn-ghost{background:transparent;color:#dcdcdc;border:1px solid #2b2b2b}
.btn-disabled{opacity:.6;cursor:not-allowed}

/* Watchlist */
.wl-list{list-style:none;padding:0;margin:0 auto;max-width:840px}
.wl-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  background:var(--panel);
  padding:12px 14px;
  margin-bottom:10px;
  border-radius:10px;
  transition:background .12s ease, transform .08s ease;
}
.wl-item:hover{background:var(--panel-hover)}
.wl-left{display:flex;gap:12px;align-items:center;min-width:0}
.wl-symbol{font-weight:800;color:var(--accent);font-size:1.05rem;white-space:nowrap}
.wl-company{color:var(--muted);font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px}
.wl-right{display:flex;align-items:center;gap:10px}
.wl-price{font-weight:700;color:#dcdcdc;min-width:110px;text-align:right;font-variant-numeric:tabular-nums}
.wl-price.unknown{color:var(--muted)}
.wl-change{font-weight:700;font-variant-numeric:tabular-nums}
.remove-stock{background:transparent;border:0;color:var(--danger);font-size:1.15rem;cursor:pointer;padding:6px;border-radius:6px}
.remove-stock:hover{transform:scale(1.06)}

/* Skeleton & empty */
.skeleton-wrapper{margin:12px auto;max-width:840px}
.skeleton{height:56px;border-radius:8px;margin-bottom:10px;background:linear-gradient(90deg,#1f242c 25%,#252b34 50%,#1f242c 75%);background-size:200% 100%;animation:shimmer 1s linear infinite}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.empty-state{text-align:center;color:var(--muted);margin-top:14px;font-size:15px}

/* toast */
.toast{position:fixed;right:18px;bottom:18px;background:rgba(18,18,18,0.96);color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.5);z-index:2000}

/* responsive */
@media(max-width:600px){
  .wl-item{flex-direction:column;align-items:flex-start}
  .wl-price{text-align:left;min-width:auto}
  .main-nav ul{display:none}
  .content{padding:0 12px 48px}
}
</style>
</head>
<body>
<header class="header">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="brand">Stock Simulator</div>
  </div>
  <nav class="main-nav" aria-label="Main navigation">
    <ul>
      <li><a href="/static/dashboard.html">Dashboard</a></li>
      <li><a href="/static/portfolio.html">Portfolio</a></li>
      <li><a href="/static/tradingterminal.html">Trading-Terminal</a></li>
      <li><a href="/static/login.html">Logout</a></li>
    </ul>
  </nav>
</header>

<main class="content" role="main">
  <div class="controls" aria-label="Watchlist controls">
    <input id="w-search" type="text" placeholder="Add stock symbol (e.g. AAPL)" aria-label="Stock symbol" />
    <button id="add-to-watchlist" class="btn btn-primary">Add</button>
    <button id="refresh-watchlist" class="btn btn-ghost">Refresh</button>
  </div>

  <div id="skeleton" class="skeleton-wrapper" aria-hidden="true" style="display:none">
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
  </div>

  <div id="watchlist-container" style="text-align:center"></div>
  <div id="empty-state" class="empty-state" style="display:none">Your watchlist is empty.</div>
</main>

<!-- Toast root -->
<div id="toast-root" aria-live="polite" aria-atomic="true" style="pointer-events:none"></div>

<script>
/*
  Single-file, copy-paste ready watchlist UI.
  Uses delete-by-symbol. Keeps full features: add, refresh, cache, optimistic UI.
*/

// ---------- Config ----------
const API_ADD = "/api/watchlist";         // POST { symbol }
const API_FULL = "/api/watchlist/full";   // GET -> array or {data: [...]}
const API_DELETE_BASE = "/api/watchlist"; // DELETE /{symbol}
const LOCAL_CACHE_KEY = "watchlist_local_cache_v2";
const CACHE_TTL_MS = 30 * 60 * 1000; // 30 minutes

// ---------- Elements ----------
const container = document.getElementById("watchlist-container");
const addBtn = document.getElementById("add-to-watchlist");
const refreshBtn = document.getElementById("refresh-watchlist");
const searchInput = document.getElementById("w-search");
const skeletonEl = document.getElementById("skeleton");
const emptyEl = document.getElementById("empty-state");
const toastRoot = document.getElementById("toast-root");

// ---------- Helpers ----------
function showSkeleton(show){ skeletonEl.style.display = show ? "block" : "none"; }
function showEmpty(show){ emptyEl.style.display = show ? "block" : "none"; }
function nowTs(){ return Date.now(); }
function safeParse(s){ try{return JSON.parse(s);}catch{return null;} }
function formatPrice(v){ if (v===null||v===undefined||isNaN(v)) return "—"; return Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

function showToast(msg, ms=3000){
  const t = document.createElement("div");
  t.className = "toast";
  t.style.pointerEvents = "auto";
  t.textContent = msg;
  toastRoot.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.remove(),250); }, ms);
}

// ---------- Local Cache ----------
function writeLocalCache(data){
  try{ localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify({ts:nowTs(),data})); } catch(e){ console.warn("cache write failed", e); }
}
function readLocalCache(){
  try{
    const raw = localStorage.getItem(LOCAL_CACHE_KEY);
    if(!raw) return null;
    const parsed = safeParse(raw);
    if(!parsed || !parsed.ts || !parsed.data) return null;
    if(nowTs() - parsed.ts > CACHE_TTL_MS) return null;
    return parsed.data;
  } catch(e){ return null; }
}

// ---------- Normalization ----------
function normalizeServerItems(arr){
  return (arr||[]).map(it => ({
    id: it.id ?? null,
    symbol: (it.symbol || "").toUpperCase(),
    stock_name: it.stock_name ?? it.name ?? it.company_name ?? null,
    current_price: (typeof it.current_price !== "undefined") ? it.current_price : (it.currentPrice ?? null),
    change_percent: (typeof it.change_percent !== "undefined") ? it.change_percent : (it.change ?? null)
  }));
}

// ---------- Render ----------
function renderWatchlist(items){
  container.innerHTML = "";
  if(!items || items.length === 0){
    showEmpty(true);
    return;
  }
  showEmpty(false);

  const ul = document.createElement("ul");
  ul.className = "wl-list";

  items.forEach(it => {
    const symbol = it.symbol;
    const company = it.stock_name || "";
    const priceRaw = it.current_price;
    const priceText = (priceRaw === null || priceRaw === undefined) ? "—" : `$${formatPrice(priceRaw)}`;
    const priceClass = (priceRaw === null || priceRaw === undefined) ? "wl-price unknown" : "wl-price";

    let changeHtml = "";
    if (typeof it.change_percent !== "undefined" && it.change_percent !== null) {
      const c = Number(it.change_percent);
      const sign = c >= 0 ? "+" : "";
      const color = c >= 0 ? "var(--accent)" : "var(--danger)";
      changeHtml = `<div class="wl-change" style="color:${color};font-size:0.95rem">${sign}${c.toFixed(2)}%</div>`;
    }

    const li = document.createElement("li");
    li.className = "wl-item";
    if (it.id !== null) li.setAttribute("data-id", it.id);
    li.setAttribute("data-symbol", symbol);

    li.innerHTML = `
      <div class="wl-left">
        <div>
          <div class="wl-symbol">${symbol}</div>
          <div class="wl-company">${company}</div>
        </div>
      </div>

      <div class="wl-right">
        <div class="${priceClass}">${priceText}</div>
        ${changeHtml}
        <button class="remove-stock" data-symbol="${symbol}" title="Remove ${symbol}" aria-label="Remove ${symbol}">✖</button>
      </div>
    `.trim();

    ul.appendChild(li);
  });

  container.appendChild(ul);

  // Event delegation for remove (delete-by-symbol)
  ul.addEventListener("click", async (e) => {
    const btn = e.target.closest(".remove-stock");
    if (!btn) return;
    const li = btn.closest(".wl-item");
    const sym = btn.dataset.symbol;
    if (!sym) return;
    btn.disabled = true;

    try {
      await deleteBySymbol(sym);
      showToast(`Removed ${sym}`);
      localStorage.removeItem(LOCAL_CACHE_KEY);
      await loadWatchlist();
    } catch (err) {
      console.error("remove error", err);
      let message = "Failed to remove stock";
      if (err && err.message) message = err.message;
      showToast(message);
      btn.disabled = false;
    }
  }, { once: false });
}

// ---------- Network calls ----------
async function fetchFullFromServer(){
  const res = await fetch(API_FULL, {
    method: "GET",
    credentials: "include",
    headers: { "Accept": "application/json", "Cache-Control": "no-cache" }
  });
  if (!res.ok) {
    const txt = await res.text().catch(()=>"");
    throw new Error(`Server ${res.status} ${txt}`);
  }
  const json = await res.json();
  if (Array.isArray(json)) return json;
  if (json && Array.isArray(json.data)) return json.data;
  return [];
}

async function addStock(symbol){
  const res = await fetch(API_ADD, {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json", "Accept": "application/json" },
    body: JSON.stringify({ symbol })
  });
  if (!res.ok) {
    let msg = `Server ${res.status}`;
    try { const j = await res.json(); if (j && (j.detail || j.message)) msg = j.detail || j.message; } catch(_) {}
    throw new Error(msg);
  }
  try { return await res.json(); } catch { return null; }
}

async function deleteBySymbol(symbol){
  const url = `${API_DELETE_BASE}/${encodeURIComponent(String(symbol))}`;
  const res = await fetch(url, { method: "DELETE", credentials: "include" });
  if (!res.ok && res.status !== 204) {
    let msg = `Server ${res.status}`;
    try { const j = await res.json(); if (j && j.detail) msg = j.detail; } catch(_) {}
    throw new Error(msg);
  }
}

// ---------- Load flow ----------
async function loadWatchlist(){
  showSkeleton(true);
  container.innerHTML = "";
  showEmpty(false);

  try {
    const raw = await fetchFullFromServer();
    const normalized = normalizeServerItems(raw);
    renderWatchlist(normalized);
    writeLocalCache(normalized);
    if (!normalized.length) {
      container.innerHTML = "";
      showEmpty(true);
    }
  } catch (err) {
    console.warn("fetch failed", err);
    const cached = readLocalCache();
    if (cached && Array.isArray(cached) && cached.length) {
      renderWatchlist(cached);
      showToast("⚡ Showing cached watchlist (offline)");
    } else {
      showEmpty(true);
      container.innerHTML = `<div style="color:#ffb86b;margin-top:12px;text-align:center;">Unable to fetch watchlist from server and no cached data found.</div>`;
    }
  } finally {
    showSkeleton(false);
  }
}

// ---------- UI actions ----------
addBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  const sym = (searchInput.value || "").trim().toUpperCase();
  if (!sym) return showToast("Please enter a stock symbol");
  addBtn.disabled = true;
  addBtn.classList.add("btn-disabled");
  const prevText = addBtn.textContent;
  addBtn.textContent = "Adding...";
  try {
    await addStock(sym);
    localStorage.removeItem(LOCAL_CACHE_KEY);
    searchInput.value = "";
    showToast(`${sym} added`);
    await loadWatchlist();
  } catch (err) {
    console.error("add failed", err);
    const message = (err && err.message) ? err.message : "Error adding stock";
    showToast(message);
  } finally {
    addBtn.disabled = false;
    addBtn.classList.remove("btn-disabled");
    addBtn.textContent = prevText;
  }
});

refreshBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  localStorage.removeItem(LOCAL_CACHE_KEY);
  await loadWatchlist();
});

// enter => add
searchInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") { e.preventDefault(); addBtn.click(); }
});

// initial load
document.addEventListener("DOMContentLoaded", loadWatchlist);
</script>
</body>
</html>